---
layout: blog
time-series-process: true
mathjax: true
date:   2021-11-26
background-image: https://7568.github.io/images/2021-11-26-tabnet/img.png
title:  TabNet - Attentive Interpretable Tabular Learning
category: time series å¤„ç†
tags:
- tabular data
- time series
---

[tabnet-architecture]:https://7568.github.io/images/2021-11-26-tabnet/tabnet-architecture.png
[sparsemax-compare-softmax]:https://7568.github.io/images/2021-11-26-tabnet/sparsemax-compare-softmax.png
[all-samples]:https://7568.github.io/images/2021-11-26-tabnet/all-samples.png

# ç®€ä»‹

TabNet æ˜¯2020å¹´ Google Cloud AI å›¢é˜Ÿå‘è¡¨çš„ä¸€ç¯‡ç”¨æ¥å¤„ç†è¡¨æ ¼æ•°æ®çš„æ·±åº¦ç¥ç»ç½‘ç»œæ¨¡å‹ï¼Œå®ƒå¯è§£é‡Šæ€§å¼ºè€Œä¸”ä½¿ç”¨åˆ°äº†è‡ªç›‘ç£æŠ€æœ¯ï¼Œæœ¬æ–‡å°†
é€šè¿‡[ğŸ’ ğŸ’ ğŸ’ è®ºæ–‡ ğŸ’ ğŸ’ ğŸ’](https://arxiv.org/pdf/1908.07442.pdf) å’Œ[ğŸ’ ğŸ’ ğŸ’ ä»£ç  ğŸ’ ğŸ’ ğŸ’(éå®˜æ–¹)](https://github.com/dreamquark-ai/tabnet) æ¥å¯¹ TabNet è¿›è¡Œä»‹ç»ã€‚

# è®ºæ–‡ä»‹ç»

å¯¹äºå¤„ç† tabular ç±»å‹çš„æ•°æ®ï¼Œç›®å‰ä½¿ç”¨åŸºäºæ ‘ç»“æ„çš„é›†æˆå­¦ä¹ æ¡†æ¶ä¼šæœ‰å¾ˆå¥½çš„æ•ˆæœã€‚ä¾‹å¦‚ [ğŸ’ LightGBM ğŸ’](#LightGBM) å’Œ [ğŸ’ XDBoost ğŸ’](#XDBoost) åœ¨ä¼—å¤š tabular ç±»å‹çš„æ•°æ®å¤„ç†ä»»åŠ¡ä¸­éƒ½æœ‰ç²¾å½©çš„è¡¨ç°ã€‚
ä½†æ˜¯ TabNet æœ‰è‡ªå·±çš„ä¼˜ç‚¹ï¼Œè€Œä¸”åœ¨å¾ˆå¤šä»»åŠ¡é‡å¹¶ä¸æ¯”å®ƒä»¬å·®ã€‚

TabNet ä¼˜ç‚¹å¦‚ä¸‹ï¼š
1. æ–¹ä¾¿ä½¿ç”¨ï¼Œå¯¹åŸå§‹æ•°æ®ä¸éœ€è¦åšä»»ä½•å…¶ä»–çš„æ“ä½œï¼Œå°±èƒ½ç›´æ¥ä½¿ç”¨ï¼Œè€Œä¸” TabNet æ˜¯ç«¯å¯¹ç«¯çš„ï¼Œè®­ç»ƒèµ·æ¥éå¸¸æ–¹ä¾¿ã€‚
2. TabNet ä½¿ç”¨ attention æœºåˆ¶ï¼Œä½¿å¾—æ¨¡å‹çš„è§£é‡Šæ€§å¼ºã€‚
3. TabNet æ•ˆæœå¥½ï¼Œå¹¶ä¸”æœ‰ä¸¤ç§ä¸åŒçš„å¯è§£é‡Šæ€§ï¼Œä¸€ä¸ªæ˜¯å±€éƒ¨å¯è§£é‡Šæ€§ï¼Œä¸€ä¸ªæ˜¯å…¨å±€å¯è§£é‡Šæ€§ã€‚
4. å¯¹äºç¬¬ä¸€æ¬¡é‡è§çš„ tabular ç±»å‹çš„æ•°æ®ï¼Œæˆ‘ä»¬ä½¿ç”¨éç›‘ç£å¡«è¯æ¸¸æˆçš„æ–¹å¼å¯¹æ¨¡å‹è¿›è¡Œé¢„è®­ç»ƒï¼Œä½¿å¾—æ¨¡å‹åœ¨è¯¥æ•°æ®ä¸Šæœ‰å¾ˆå¥½çš„è¡¨ç°ã€‚

æ‰€è°“éç›‘ç£å¡«è¯æ¸¸æˆå°±æ˜¯æŠŠæ ·æœ¬æ•°æ®éšæœºçš„é€‰æ‹©ä¸€äº›å±æ€§ç½®ä¸ºç©ºï¼Œç„¶åè®©ç½‘ç»œæ¥è¿›è¡Œé¢„æµ‹å­¦ä¹ ã€‚å½“ç½‘ç»œå¯¹è¯¥æ•°æ®çš„å¡«è¯æ¸¸å·²ç»å¤„ç†å¾—
å¾ˆå¥½ä¹‹åï¼Œç„¶åå†æ¥è¿›è¡Œå¯¹è¯¥æ•°æ®çš„å®é™…ä»»åŠ¡çš„å¾®è°ƒè®­ç»ƒï¼Œä»è€Œæé«˜ç½‘ç»œåœ¨å®é™…ä»»åŠ¡ä¸Šçš„æ€§èƒ½ã€‚é€šå¸¸æˆ‘ä»¬å¯ä»¥æŠŠè¿™ç§é¢„è®­ç»ƒå¥½çš„æ¨¡å‹
å½“ä½œæ•´ä¸ªç½‘ç»œçš„ embedding å±‚ã€‚

ä¸‹å›¾å±•ç¤ºäº† TabNet çš„æ•´ä½“ç»“æ„

![tabnet-architecture]

æ•´ä½“åˆ†ä¸º encoder å’Œ decoder ä¸¤éƒ¨åˆ†ï¼Œåœ¨ encoder ä¸­æœ‰ä¸¤ä¸ªç‰¹æ®Šçš„ç»“æ„ï¼Œåˆ†åˆ«ä¸º feature transformerï¼Œattentive transformerå’Œ feature maskingï¼Œå…¶ä¸­ feature transformer æ˜¯
ç”¨æ¥è¿›è¡Œç‰¹å¾æå–ï¼Œattentive transformer æ˜¯ç”¨æ¥è¿›è¡Œç‰¹å¾é€‰æ‹©ï¼Œå’Œæä¾›å¯¹æ¨¡å‹çš„å¯è§£é‡Šæ€§ï¼Œè€Œ feature masking æ˜¯ç”¨æ¥è·å–å…¨å±€ç‰¹å¾é‡è¦æ€§çš„åˆ†å¸ƒã€‚
å›¾ä¸­çš„ï¼ˆaï¼‰æ˜¯ encoder ç»“æ„ï¼Œï¼ˆbï¼‰æ˜¯ decoder ç»“æ„ï¼Œï¼ˆcï¼‰æ˜¯ feature transformerï¼Œé‡Œé¢å¯ä»¥åˆ†æˆ4å±‚ï¼Œæ¯ä¸€å±‚éƒ½æ˜¯ç”± FCï¼ŒBNï¼Œ[ğŸ’ GLU ğŸ’](https://7568.github.io/2021/11/15/cnn-seq2seqModel.html#glu) æ„æˆã€‚å…¶ä¸­å‰2å±‚ä¸º Shared across decision stepsï¼Œå¦å¤–ä¸¤å±‚ä¸º Decision step dependentï¼Œ
ï¼ˆdï¼‰æ˜¯ attentive transformer ç»“æ„ï¼Œé‡Œé¢çš„ [ğŸ’ sparsemax ğŸ’](https://arxiv.org/pdf/1602.02068) ç”¨æ¥åšå½’ä¸€åŒ–å¤„ç†ï¼Œå¹¶ä¸”ç»“æœä¸­åªåŒ…å«çªå‡ºçš„ç‰¹å¾ä¿¡æ¯ã€‚

## sparsemax

sparsemax å¸¸ç”¨äºå¤šæ ‡ç­¾åˆ†ç±»ä»»åŠ¡ä¸­ï¼Œé€šå¸¸å½“ä½œç¥ç»ç½‘ç»œçš„æ¿€æ´»å‡½æ•°æ”¾åœ¨æœ€åä¸€å±‚å–ä»£ softmaxã€‚sparsemax å’Œ softmax çš„åŒºåˆ«å¦‚ä¸‹ï¼š

![sparsemax-compare-softmax]

ä¸ªäººç†è§£ sparsemax çš„ä¼˜åŠ¿æ˜¯åœ¨å¤šåˆ†ç±»ä»»åŠ¡ä¸­ï¼Œä½¿ç”¨ sparsemax èƒ½å¤Ÿå¹³è¡¡ä¸€ä¸ªæ ·æœ¬å±äºå¤šä¸ªåˆ†ç±»çš„æƒé‡ï¼Œè€Œåœ¨ softmax ä¸­
ä¸€ä¸ªæ ·æœ¬è™½ç„¶å¯èƒ½å±äºå¤šä¸ªç±»åˆ«ï¼Œä½†æ˜¯ä»–ä»¬çš„æƒé‡å´æ˜¯ä¸ä¸€æ ·çš„ã€‚ä¾‹å¦‚æŸä¸€ä¸ªæ ·æœ¬å±äº1ï¼Œ2ä¸¤ä¸ªç±»åˆ«ï¼Œå¦‚æœæˆ‘ä»¬çš„ç½‘ç»œç®—å¾—è¯¥æ ·æœ¬åœ¨ç±»åˆ«1ï¼Œ2ä¸Šçš„
softmax å€¼åˆ†åˆ«ä¸º0.7å’Œ0.9ï¼Œè€Œä¸”è¿™ä¸¤ä¸ªå€¼ä¹Ÿæ˜¯æœ€å¤§çš„ä¸¤ä¸ªå€¼ï¼Œè™½ç„¶æœ€ç»ˆç»“æœèƒ½å¾—å‡ºè¯¥æ ·æœ¬å±äº1ï¼Œ2ä¸¤ä¸ªç±»åˆ«ï¼Œä½†æ˜¯å…¶å®
ç½‘ç»œåœ¨åå‘æ±‚å¯¼çš„è¿‡ç¨‹ä¸­è¿˜æ˜¯ä¼šæƒ©ç½šè¿™ä¸¤ä¸ªè¾“å‡ºï¼Œå› ä¸ºä»–ä»¬ä¸æ˜¯1ï¼Œè€Œå¦‚æœä½¿ç”¨ sparsemax å°±ä¸ä¼šè¿™æ ·ï¼Œç»“æœä¹Ÿæ˜¯èƒ½å¤Ÿå¾—å‡ºè¯¥æ ·æœ¬
å±äº1ï¼Œ2ä¸¤ä¸ªç±»åˆ«ï¼Œè€Œä¸”åå‘çš„æ—¶å€™ä¸ä¼šå¯¹å®ƒä»¬è¿›è¡Œæƒ©ç½šã€‚æ‰€ä»¥ sparsemax åœ¨æŸäº›åº”ç”¨ä¸­ä¼¼ä¹ä¼šæ›´åŠ åˆç†ä¸€äº›ã€‚

## LightGBM

## XDBoost

## gradient-boosted DT

# ä»£ç 

åœ¨ [ğŸ’ dreamquark-ai ğŸ’](https://github.com/dreamquark-ai/tabnet) çš„ tabnet å®ç°ä»£ç ä¸­æœ‰7ä¸ª example ï¼Œä»–ä»¬åˆ†åˆ«æ˜¯ï¼š
- tabnet å¯¹ç¾å›½äººå£æ•°æ®åˆ†ç±»é¢„æµ‹çš„åŸºæœ¬ä½¿ç”¨ä»‹ç» [ğŸ’ census_example.ipynb ğŸ’](https://github.com/dreamquark-ai/tabnet/blob/develop/census_example.ipynb)
- è‡ªå®šä¹‰è§„åˆ™çš„ tabnet åˆ†ç±»é¢„æµ‹ä½¿ç”¨ä»‹ç»ï¼Œ[ğŸ’ customizing_example.py ğŸ’](https://github.com/dreamquark-ai/tabnet/blob/develop/customizing_example.py)
- tabnet å¯¹æ£®æ—è¦†ç›–ç‡æ•°æ®åˆ†ç±»é¢„æµ‹çš„åŸºæœ¬ä½¿ç”¨ä»‹ç» [ğŸ’ forest_example.py ğŸ’](https://github.com/dreamquark-ai/tabnet/blob/develop/forest_example.py)
- tabnet å¯¹å›å½’æ•°æ®çš„åŸºæœ¬ä½¿ç”¨ä»‹ç» [ğŸ’ regression_example.py ğŸ’](https://github.com/dreamquark-ai/tabnet/blob/develop/regression_example.py)
- tabnet å¯¹å¤šåˆ†ç±»ä»»åŠ¡çš„ä½¿ç”¨ä»‹ç» [ğŸ’ multi_task_example.py ğŸ’](https://github.com/dreamquark-ai/tabnet/blob/develop/multi_task_example.py)
- tabnet å¯¹å¤šå›å½’ä»»åŠ¡çš„ä½¿ç”¨ä»‹ç» [ğŸ’ multi_regression_example.py ğŸ’](https://github.com/dreamquark-ai/tabnet/blob/develop/multi_regression_example.py)
- å¸¦è‡ªç›‘ç£çš„é¢„è®­ç»ƒæ¨¡å‹çš„tabnetå¯¹åˆ†ç±»ä»»åŠ¡çš„ä½¿ç”¨ä»‹ç» [ğŸ’ pretraining_example.py ğŸ’](https://github.com/dreamquark-ai/tabnet/blob/develop/pretraining_example.py)

æœ¬æ¥ä¸Šé¢çš„ä»£ç ï¼Œå¯¹ tabnet çš„åŸºæœ¬çš„ä½¿ç”¨æ˜¯æ²¡é—®é¢˜çš„ï¼Œä½†æ˜¯åšç ”ç©¶ä¸èƒ½åªæ˜¯ä¼šç”¨ï¼Œè¿˜å¾—ææ˜ç™½åˆ«äººæ˜¯æ€ä¹ˆå®ç°çš„ã€‚æ‰€ä»¥æ¥ä¸‹æ¥æˆ‘å°†é‡æ–°æ”¹å†™ä¸€ä¸‹ä¸Šé¢çš„ä»£ç ï¼Œå°†è°ƒç”¨æ¥å£çš„åœ°æ–¹å…¨éƒ¨æ”¹æˆæ–¹æ³•çš„å®ç°ã€‚
è™½ç„¶æœ€åæˆ‘ç»å¤§éƒ¨åˆ†çš„ä»£ç è¿˜æ˜¯ä½¿ç”¨çš„ [ğŸ’ dreamquark-ai ğŸ’](https://github.com/dreamquark-ai/tabnet) ä¸­æä¾›çš„ï¼Œä½†æ˜¯æˆ‘ä»£ç å®ç°çš„ç›®çš„ä¸ä¸€æ ·ï¼Œè§‚ä¼—çœ‹æˆ‘çš„ä»£ç çš„è¯èƒ½æ›´å¥½çš„ç†è§£ tabnet çš„åŸç†å’Œå®ç°æ–¹æ³•ï¼Œ
è€Œ [ğŸ’ dreamquark-ai ğŸ’](https://github.com/dreamquark-ai/tabnet) çš„ä»£ç ä¸»è¦æ˜¯æ–¹ä¾¿åˆ«äººä½¿ç”¨ï¼Œæ‰€ä»¥é‡Œé¢ä¼šæœ‰å¾ˆå¤šåœ°æ–¹åšäº†å„ç§å°è£…å„ç§æ¥å£åŒ–ï¼Œå¯¹äºæƒ³å­¦ä¹  tabnet çš„äººæ¥è¯´æ˜¯å¾ˆä¸å‹å¥½çš„ã€‚

## tabnet åŸºæœ¬æ•°æ®åˆ†ç±»ä»»åŠ¡

é¦–å…ˆæ˜¯æ•°æ®å‡†å¤‡ï¼Œæˆ‘ä»¬çš„æ•°æ®æ˜¯ä¸€ä»½ç¾å›½éƒ¨åˆ†äººå£çš„è°ƒæŸ¥æ•°æ®ï¼Œæˆ‘ä»¬çš„ä»»åŠ¡æ˜¯é€šè¿‡è®­ç»ƒè¯¥æ•°æ®æ¥é¢„æµ‹ä¸åŒçš„äººçš„æ”¶å…¥å¹´æ”¶å…¥æ˜¯å¦å¤§äº50Kã€‚å‰10æ¡æ•°æ®å¦‚ä¸‹

![all-samples]

æˆ‘ä»¬æœ€ç»ˆéœ€è¦æ¥é¢„æµ‹ "<=50K" è¿™ä¸ªåˆ—çš„æ•°æ®ã€‚é¦–å…ˆæˆ‘ä»¬æ˜¯è¦è¿›è¡Œç©ºå€¼çš„å¡«å……ï¼Œç„¶åå†å°†å­—ç¬¦ä¸²æ•°æ®è½¬æ¢æˆæ•°ç»„æ•°æ®ï¼Œæœ€åæˆ‘ä»¬å°†æ•°æ®æŒ‰ç…§8ï¼š1ï¼š1çš„æ¯”ä¾‹åˆ†æˆ3ä»½ï¼Œåˆ†åˆ«æ˜¯trainï¼Œvalidationï¼Œå’Œtestã€‚å…¶ä¸­
trainç”¨æ¥è®­ç»ƒï¼Œvalidationç”¨æ¥åœ¨è®­ç»ƒçš„æ—¶å€™æ£€éªŒæ•ˆæœï¼Œtestç”¨æ¥åœ¨è®­ç»ƒå®Œæˆä¹‹åæ£€éªŒæ•ˆæœã€‚
```python
#!/usr/bin/env python
# coding: utf-8
from pytorch_tabnet.tab_model import TabNetClassifier
import torch
from sklearn.preprocessing import LabelEncoder
from sklearn.metrics import roc_auc_score
import pandas as pd
import numpy as np
np.random.seed(1024)
import os
import wget
from pathlib import Path
from matplotlib import pyplot as plt

url = "https://archive.ics.uci.edu/ml/machine-learning-databases/adult/adult.data"
dataset_name = 'census-income'
out = Path(os.getcwd()+'/data/'+dataset_name+'.csv')

out.parent.mkdir(parents=True, exist_ok=True)
if out.exists():
    print("File already exists.")
else:
    print("Downloading file...")
    wget.download(url, out.as_posix())

train = pd.read_csv(out)
target = ' <=50K'
if "Set" not in train.columns:
    train["Set"] = np.random.choice(["train", "valid", "test"], p =[.8, .1, .1], size=(train.shape[0],))

train_indices = train[train.Set=="train"].index
valid_indices = train[train.Set=="valid"].index
test_indices = train[train.Set=="test"].index




nunique = train.nunique()
types = train.dtypes

categorical_columns = []
categorical_dims =  {}
for col in train.columns:
    if types[col] == 'object' or nunique[col] < 200:
        print(col, train[col].nunique())
        l_enc = LabelEncoder()
        train[col] = train[col].fillna("VV_likely")
        train[col] = l_enc.fit_transform(train[col].values)
        categorical_columns.append(col)
        categorical_dims[col] = len(l_enc.classes_)
    else:
        train.fillna(train.loc[train_indices, col].mean(), inplace=True)

train.loc[train[target]==0, target] = "wealthy"
train.loc[train[target]==1, target] = "not_wealthy"

unused_feat = ['Set']

features = [ col for col in train.columns if col not in unused_feat+[target]] 

cat_idxs = [ i for i, f in enumerate(features) if f in categorical_columns]

cat_dims = [ categorical_dims[f] for i, f in enumerate(features) if f in categorical_columns]

```
æ¥ä¸‹æ¥æˆ‘ä»¬æ„é€ æ•°æ®åŠ è½½å™¨ï¼Œ
æ¥ä¸‹æ¥æˆ‘ä»¬å¼€å§‹è¿›è¡Œæ¨¡å‹çš„æ„é€ ï¼Œ

 
[ğŸ’ INVASE ğŸ’](https://openreview.net/pdf?id=BJg_roAcK7) è®ºæ–‡ä¸­ç”¨å®éªŒè¯´æ˜äº†ä½¿ç”¨å¸¦é€‰æ‹©æ€§çš„featureæ¯”ä½¿ç”¨å…¨éƒ¨çš„featureæ•ˆæœè¦å¥½ã€‚

[ğŸ’ å¼ºåŒ–å­¦ä¹ RL ğŸ’](https://openreview.net/pdf?id=B1gJOoRcYQ)


