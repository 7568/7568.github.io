---
layout: blog
images-process: true
mathjax: true
title: "神经网络去燥-FFDNet"
background-image: https://7568.github.io/images/2021-11-07-FFDNet/img.png
date:  2021-11-07
category: 图像处理
tags:
- 神经网络
- 去燥
---


# 模型介绍

[FFDNet: Toward a Fast and Flexible Solution for CNN based Image Denoising](https://arxiv.org/pdf/1710.04026.pdf) 是Kai Zhang, Wangmeng Zuo, Senior Member, IEEE, and Lei Zhang, Fellow, IEEE 等人在2018年发表的一篇关于图像去燥的文章
该文章在合成的高斯白噪声（AWGN）的图像上的去燥效果很好。本文将大概介绍一下这篇文章中具体使用的方法和代码的实现。

首先，它不是一个我们常用的U型网络，也没有使用到res_block，而这两个结构通常会被用到图像处理的任务中，在[这篇文章](http://www.ipol.im/pub/art/2019/231/article.pdf) 中，有人给FFDNet做了对比实验，发现其实加上参差块，去燥的效果是有提升的，但是幅度很小。

下图是FFDNet的整体结构：

![FFDNet](https://7568.github.io/images/2021-11-07-FFDNet/architecture-of-FFDNet.png)

从图中我们可以看到有一个特别的地方，就是在输入到神经网络之前，原始的噪声图像有做一个处理，该处理的过程如下：（假设图像的维度为(c,w,h)）
1. 将图像中相邻的四个像素分成一个组，那么原始图像在某一个通道中，就被分成了 $$ \lfloor w/4 \times h/4 \rfloor $$ 个组，多余的部分舍弃掉。
2. 将所有组中位置相同的像素提取出来，组成一个新的通道，于是原来c个通道就变成了 4$$\times$$c 个通道。
3. 然后将4*c个通道的图像在拼接上噪声图，一起放入神经网络中
4. 最后输出的通道数也为4 $$\times$$ c，然后按照1的逆操作，将 4 $$\times$$ c 个通道的图像，转换成c个通道的图像

步骤1的示意图如下：

   ![downscaling-layer.png](https://7568.github.io/images/2021-11-07-FFDNet/downscaling-layer.png)

<div align="center" style="font-weight: bold;">   图2： 将原始图像进行切分，切分之后再合并成一个大小为原来 1/4 的图像   </div>

步骤4的示意图如下：

   ![upscaling-layer.png](https://7568.github.io/images/2021-11-07-FFDNet/upscaling-layer.png)

<div align="center" style="font-weight: bold;"> 图3：将输出进行合并 </div>

# 实验过程

pytorch 版本的训练代码可以在这个地址下载 [An Analysis and Implementation of the FFDNet Image Denoising Method](http://www.ipol.im/pub/art/2019/231/) ，里面还包含有一篇关于FFDNet的分析论文。

FFDNet使用的训练数据集为Waterloo Exploration Database，和 BSD400 ，Waterloo Exploration Database数据集中有4744张图像彩色图像，BSD400是400张黑白图像。 FFDNet论文中的做法是随机的从这4744+400张图像切出 128$$ \times $$8000 张小图，其中黑白小图的大小为 70$$ \times $$70 ，彩色图像的大小为 50$$ \times $$50 。
噪声范围为 $$\sigma \in [0, 75] $$ ，均匀的从中随机选择。还使用了 rotation 和 flip 方法进行数据增强。

FFDNet训练时学习率在前50个epochs中是1e−3，然后在50-60个epochs中，将学习率调整为1e−4，剩下的epochs，学习率设置为 1e−6，总共训练了80个epochs。

FFDNet使用的验证集有两种，分别为黑白图像数据集和彩色图像数据集，BSD68和Set12用来进行黑白图像的去燥验证，CBSD68和 Kodak24用来进行彩色图像的去燥验证

所有实验所需的数据集都可以在[xinntao / BasicSR](https://github.com/xinntao/BasicSR/blob/master/docs/DatasetPreparation.md#common-image-sr-datasets) 和 [cszn / DnCNN](https://github.com/cszn/DnCNN/tree/master/TrainingCodes/DnCNN_TrainingCodes_v1.0/data) 中找到下载地址。

在 [An Analysis and Implementation of the FFDNet Image Denoising Method](http://www.ipol.im/pub/art/2019/231/) 的代码中，我们可以看到有 `prepare_patches.py` 、`train.py` 和 `test_ffdnet_ipol.py` 。
我们通过 `prepare_patches.py` 文件来进行训练数据的预处理，
